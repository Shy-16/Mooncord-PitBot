{% extends "_base.html" %}

{% block title %}Closed Ticket{% endblock %}

{% block js %}
	<script src="{{ url_for('static', filename='node_modules/lightense-images/dist/lightense.min.js') }}" type="text/JavaScript"></script>
	<script src="{{ url_for('static', filename='js/modmail_readonly_ticket.js') }}" type="text/JavaScript"></script>
{% endblock %}

{% block style %}
<link href="{{ url_for('static', filename='css/modmail_ticket.css') }}" rel="stylesheet" media="screen">
{% endblock %}
 
{% block content %}
<div id="drop_zone" class="d-none">
  <div>Drop one file to add as attachment.</div>
</div>
<div class="container">
	<input type="hidden" id="ticket-id" value="{{ ticket['_id'] }}">
	<input type="hidden" id="channel-id" value="{{ ticket['channel_id'] }}">

	<div class="row mt-3">
		<div class="col-12">
			<h1>Ticket #{{ ticket['_id'] }}</h1>
		</div>
	</div>

	<div class="mt-3 row">
		<div class="col-8 chat">

			{% for entry in ticket['history'] %}
			<div class="chat-message {{ 'user' if entry['user_id'] == ticket['user_id'] else 'mod' }}" data-id="{{ entry['_id'] }}">
				<div class="message-user user-id" data-id="{{entry['user_id']}}">
					<img src="{{ build_avatar_url(entry['user']['discord_id'], entry['user']['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ entry['user']['username'] }}#{{ entry['user']['username_handle'] }}
				</div>
				<div class="message-time">{{ date_to_string(entry['created_date']) }}</div>
				<div class="message-content">{{ entry['message'] | replace('\n', '<br>') | safe}}</div>
				{%- if entry ['attachments'] -%}
				<div class="message-attachments">
				{% for att in entry['attachments'] %}
					<img src="{{ att['url'] }}" data-background="rgba(33, 33, 33, .7)" />
				{% endfor %}
				</div>
				{% endif %}
			</div>
			{% endfor %}

			<div class="chat-message closing-comment">
				<div class="message-user user-id" data-id="{{ticket['closing_user']['discord_id']}}">
					<img src="{{ build_avatar_url(ticket['closing_user']['discord_id'], ticket['closing_user']['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ ticket['closing_user']['username'] }}#{{ ticket['closing_user']['username_handle'] }}
				</div>
				<div class="message-time">{{ date_to_string(ticket['closed_date']) }} Â· <b>Ticket Closing Comment</b></div>
				<div class="message-content">{{ ticket['closed_comment'] | replace('\n', '<br>') | safe}}</div>
			</div>

		</div>
		<div class="col info">
			<div class="chat-buttons">
				<button class="btn btn-outline-warning" type="button" data-bs-toggle="modal" data-bs-target="#reopen-modal">Reopen Ticket</button>
			</div>
			<div class="chat-user user">
				<div class="user-info user-id" data-id="{{ticket['user_id']}}">
					<img src="{{ build_avatar_url(ticket['user']['discord_id'], ticket['user']['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ ticket['user']['username'] }}#{{ ticket['user']['username_handle'] }}
				</div>
				<div class="user-role">Ticket Creator</div>
			</div>
			{% for user in ticket['users'] %}
			<div class="chat-user mod">
				<div class="user-info user-id" data-id="{{user['discord_id']}}">
					<img src="{{ build_avatar_url(user['discord_id'], user['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ user['username'] }}#{{ user['username_handle'] }}
				</div>
				<div class="user-role">Participant</div>
			</div>
			{% endfor %}
		</div>
	</div>
	
</div>

<div class="modal fade" id="reopen-modal" tabindex="-1" aria-labelledby="Delete Ticket" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

      	<p class="text-warning"><b><i class="bi bi-exclamation-triangle-fill"></i> Are you sure you want to reopen this ticket?</b></p>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <a href="{{ url_for('modmail.reopen_ticket', ticket_id=ticket['_id']) }}" id="reopen-ticket-button" class="btn btn-warning">Reopen Ticket</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}