{% extends "_base.html" %}

{% block title %}Tickets{% endblock %}

{% block js %}
	<script src="{{ url_for('static', filename='js/modmail_index.js') }}" type="text/JavaScript"></script>
{% endblock %}

{% block style %}
<link href="{{ url_for('static', filename='css/modmail_index.css') }}" rel="stylesheet" media="screen">
{% endblock %}
 
{% block content %}
<div class="container">

	<div class="row mt-3">
		<div class="col-12">
			<h1>Modmail</h1>
		</div>
	</div>

	<form method="GET" action="{{ url_for('modmail.index') }}">
		<div class="mt-3 row search-container">
			<div class="col-4">
				<div class="input-group">
					<input type="text" id="search-user-input" class="form-control" placeholder="Username or ID" aria-label="Username or ID" aria-describedby="search-user-addon">
					<button class="btn btn-secondary" type="button" id="search-user-addon"><i class="bi bi-search"></i></button>
				</div>
			</div>
			<div class="col-auto"><label class="col-form-label">Filter:</label></div>
			<div class="col-2">
				<select id="filter-input" class="form-select" name="status" aria-label="Sorting options">
					<option value="active">Active</option>
					<option value="closed" {{ 'selected' if request.args['status'] == 'closed' }}>Closed</option>
				</select>
			</div>
			<div class="col-auto"><label class="col-form-label">Sort:</label></div>
			<div class="col-2">
				<select class="form-select" aria-label="Sorting options">
					<option value="strikes" selected>Created Date</option>
					<option value="id">Replies</option>
					<option value="username">Username</option>
				</select>
			</div>
		</div>
	</form>

	<div class="mt-3 row">
		<div class="col-12">

			{% for ticket in tickets %}
			<div class="ticket">
				<div class="ticket-user">
					<img src="{{ build_avatar_url(ticket['user']['discord_id'], ticket['user']['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ ticket['user']['username'] }}#{{ ticket['user']['username_handle'] }}
				</div>
				<div class="ticket-created"><label>Created on:</label> {{ date_to_string(ticket['created_date']) }}</div>
				<div class="ticket-updated"><label>Last update:</label> {{ date_to_string(ticket['updated_date']) }}</div>
				<div class="ticket-history"><label>Total messages:</label> {{ ticket['history'] |length }}</div>
				<div class="ticket-link"><a href="{{ url_for('modmail.ticket', ticket_id=ticket['_id']) }}">{{ 'Read' if request.args['status'] == 'closed' else 'Open' }} Ticket</a></div>
				{% if ticket['history'] %}
				<div class="ticket-message"><div class="time">[{{ date_to_string(ticket['history'][-1]['created_date']) }}]</div> {{ ticket['history'][-1]['message'] }}</div>
				{% endif %}
			</div>
			{% else %}
			<i>No tickets currently open</i>
			{% endfor %}

		</div>
	</div>
	
</div>
{% endblock %}