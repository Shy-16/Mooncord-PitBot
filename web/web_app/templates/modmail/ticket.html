{% extends "_base.html" %}

{% block title %}Ticket{% endblock %}

{% block js %}
	<script src="{{ url_for('static', filename='node_modules/socket.io/client-dist/socket.io.min.js') }}" type="text/JavaScript"></script>
	<script src="{{ url_for('static', filename='node_modules/lightense-images/dist/lightense.min.js') }}" type="text/JavaScript"></script>
	<script src="{{ url_for('static', filename='js/modmail_ticket.js') }}" type="text/JavaScript"></script>
{% endblock %}

{% block style %}
<link href="{{ url_for('static', filename='css/modmail_ticket.css') }}" rel="stylesheet" media="screen">
{% endblock %}
 
{% block content %}
<div id="drop_zone" class="d-none">
  <div>Drop one file to add as attachment.</div>
</div>
<div class="container">
	<input type="hidden" id="ticket-id" value="{{ ticket['_id'] }}">
	<input type="hidden" id="channel-id" value="{{ ticket['channel_id'] }}">
	<input type="file" id="message-attachment">

	<div class="row mt-3">
		<div class="col-12">
			<h1>Ticket #{{ ticket['_id'] }}</h1>
		</div>
	</div>

	<div class="mt-3 row">
		<div class="col-8 chat">

			{% for entry in ticket['history'] %}
			<div class="chat-message {{ 'user' if entry['user_id'] == ticket['user_id'] else 'mod' }}" data-id="{{ entry['_id'] }}">
				<div class="message-user user-id" data-id="{{entry['user_id']}}">
					<img src="{{ build_avatar_url(entry['user']['discord_id'], entry['user']['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ entry['user']['username'] }}#{{ entry['user']['username_handle'] }}
				</div>
				<div class="message-time">{{ date_to_string(entry['created_date']) }}</div>
				<div class="message-content">{{ entry['message'] | replace('\n', '<br>') | safe}}</div>
				{%- if entry ['attachments'] -%}
				<div class="message-attachments">
				{% for att in entry['attachments'] %}
					<img src="{{ att['url'] }}" data-background="rgba(33, 33, 33, .7)" />
				{% endfor %}
				</div>
				{% endif %}
			</div>
			{% endfor %}

			<div class="form-group chat-send-input">
				<textarea id="send-message-input" class="form-control" rows="4" placeholder="Send message" aria-label="Username or ID" aria-describedby="search-user-addon"></textarea>
			</div>
			<div class="chat-send-attachments"></div>

		</div>
		<div class="col info">
			<div class="chat-buttons">
				<button class="btn btn-outline-warning" type="button" data-bs-toggle="modal" data-bs-target="#close-modal">Close Ticket</button>
  			<button class="btn btn-outline-danger" type="button" data-bs-toggle="modal" data-bs-target="#delete-modal">Delete Ticket</button>
			</div>
			<div class="chat-user user">
				<div class="user-info user-id" data-id="{{ticket['user_id']}}">
					<img src="{{ build_avatar_url(ticket['user']['discord_id'], ticket['user']['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ ticket['user']['username'] }}#{{ ticket['user']['username_handle'] }}
				</div>
				<div class="user-role">Ticket Creator</div>
			</div>
			{% for user in ticket['users'] %}
			<div class="chat-user mod">
				<div class="user-info user-id" data-id="{{user['discord_id']}}">
					<img src="{{ build_avatar_url(user['discord_id'], user['avatar']) }}" width="32" class="img-responsive user-avatar" />
					{{ user['username'] }}#{{ user['username_handle'] }}
				</div>
				<div class="user-role">Participant</div>
			</div>
			{% endfor %}
			<div class="chat-info">
				<ul class="list-unstyled mb-0">
					<li><div class="key">Enter</div> to send message</li>
					<li><div class="key">Shift + Enter</div> to break line</li>
					<li><div class="key">Ctrl + V</div> to add attachment from clipboard</li>
					<li><div class="key">Drag & Drop</div> attachments to attach it</li>
					<li><div class="key">Esc</div> to cancel attachment</li>
				</ul>
			</div>
		</div>
	</div>
	
</div>

<div class="modal fade" id="close-modal" tabindex="-1" aria-labelledby="Delete Ticket" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Close Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

      	<form id="close-ticket-form" method="POST" action="{{ url_for('modmail.close_ticket', ticket_id=ticket['_id']) }}">

	      	<div class="form-floating mb-3">
						<textarea id="close-message-input" class="form-control" name="closed_comment" style="height: 150px;" aria-label="Delete Message" aria-describedby="search-user-addon"></textarea>
						<label for="close-message-input" style="color: black;">Close Message</label>
					</div>

					<div class="form-floating">
						<select id="close-action-input" class="form-select" name="action_taken" aria-label="Close Action">
							<option value="no_action" selected>No action</option>
							<option value="post_deleted_no_warning">Post deleted (no warning)</option>
							<option value="warning">Warning</option>
							<option value="pit">Pit</option>
							<option value="temp_ban">Temp Ban</option>
							<option value="perma_ban">Perma Ban</option>
						</select>
						<label for="close-action-input" style="color: black;">Close Action</label>
					</div>

			</form>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="submit-close-ticket-button" class="btn btn-warning">Close Ticket</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="delete-modal" tabindex="-1" aria-labelledby="Delete Ticket" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete Ticket</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

      	<form id="delete-ticket-form" method="POST" action="{{ url_for('modmail.delete_ticket', ticket_id=ticket['_id']) }}">

	      	<div class="form-floating mb-3">
						<textarea id="delete-message-input" name="closed_comment" class="form-control" style="height: 150px;" aria-label="Delete Message" aria-describedby="search-user-addon"></textarea>
						<label for="delete-message-input" style="color: black;">Delete Message</label>
					</div>

	        <p class="text-danger"><b><i class="bi bi-exclamation-circle-fill"></i> Deleting a Ticket cannot be undone.</b></p>

	      </form>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="submit-delete-ticket-button" class="btn btn-danger">Delete Ticket</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}